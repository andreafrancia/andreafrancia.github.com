<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title></title>

        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />

        <link rel="openid.server" href="http://www.blogger.com/openid-server.g" />
        <link rel="openid.delegate" href="http://andreafrancia.blogspot.com/" />

        <link href="/css/layout.css" rel="stylesheet" type="text/css" />
        <link href="/css/code-highlight.css" rel="stylesheet" type="text/css" />

        <link rel="alternate" type="application/rss+xml" title="Feed" href="/atom.xml" />

        <!-- Histats.com  START  --> 
<script async type="text/javascript" language="javascript"> 
var s_sid = 321314;var st_dominio = 4; 
var cimg = 0;var cwi =150;var che =30; 
</script> 
<script  async type="text/javascript" language="javascript" src="http://s11.histats.com/js9.js"/></script> 
<noscript><img src="http://s103.histats.com/stats/0.gif?321314&1" alt="contatore free" border="0"/> 
</noscript> 

<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-4316218-1']);
  _gaq.push(['_setDomainName', 'andreafrancia.it']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


    </head>
    <body>
        <div id='mainnav' class='nav'>
    <ul>
        <li><a href="/">andreafrancia.it</a>
        <li><a href="/log.html">blog</a>
        <li class="last"><a href="/tdd-ios.html">TDD su iOS</a>
    </ul>
</div>

        <div id="contents">
            <h1>Mock Object in Python</h1>
<div class='post'>
Uno dei problemi che ho quando sviluppo in Python e' che non ho ancora
trovato una libreria di mocking che mi soddisfi. Non che non ci sia scelta, ci
sono almeno tre librerie, peccato che ognuna abbia qualcosa che non mi va.
Ieri, mentre stavo scrivendo dei test per trash-cli, ho scritto una classe
<cite>Mock</cite> ex-novo adatta alle mie esigenze. L'esempio di utilizzo e' il
seguente: <br />
<pre class="python:nogutter:nocontrols" name="code">from double import Double

fs=Double('fs')
fs.on_method('volume_of').will_reply('/')
fs.on_method('exists').with_args('/.Trash').will_reply(True)
fs.on_method('has_sticky_bit').with_args('/.Trash').will_reply(True)
</pre>
La classe Ã¨ questa:<br />
<pre class="python:nogutter:nocontrols" name="code">class Double:
    def __init__(self, name):
        self.name = name
        self.expectations = {}
        self.expectations_with_args = {}
    def __getattr__(self, name):
        if name in self.expectations:
            def fake_method(*args, **kwargs):
                return self.expectations[name]
            return fake_method
        else:
            def fake_method(*args, **kwargs):
                if (name, args) in self.expectations_with_args.keys():
                    return self.expectations_with_args[(name,args)]
                self._report_unexpected_call(name, *args, **kwargs)
            return fake_method
    def __call__(self, *args, **kwargs):
        self._report_unexpected_call(self.name, args, kwargs)
    def on_method(self,name):
        class Expectation:
            def will_reply(_, return_value):
                self.expectations[name] = return_value
            def with_args(_,*args):
                class Expectation2:
                    def will_reply(_, return_value):
                        self.expectations_with_args[(name,args)] = return_value
                return Expectation2()
        return Expectation()
    def _report_unexpected_call(self, method_name, *args, **kwargs):
        assert False, ("Unexpected call: %s(%s,%s)" % ( method_name,
                     ','.join(repr(arg) for arg in args),
                     ','.join('%s=%s' %(key,value) for key, value in
                         kwargs))
                     + "Calls expected:%s and %s " %
                     (self.expectations,
                         self.expectations_with_args))
</pre>
Si tratta di una soluzione quick and dirty, molto dirty. Nonostante sia dirty
ha un suo valore. Scrivendola ho imparato che scrivere una classe di Mock non
richiede molto tempo e ora so che potrebbe volerci meno
tempo a scrivere un Mock in Python rispetto a trovare la libreria di mocking
giusta tra quelle disponibili in rete.<br />
Credo che questo dipenda essenzialmente dal fatto che Python e' un linguaggio
dinamico e che di conseguenza offre costrutti molto piu' semplici per fare
metaprogramming rispetto ad altri linguaggi con tipizzazione piu' statica.</div>

        </div>
        <!-- Histats.com  START  --> 
<script async type="text/javascript" language="javascript"> 
var s_sid = 321314;var st_dominio = 4; 
var cimg = 0;var cwi =150;var che =30; 
</script> 
<script  async type="text/javascript" language="javascript" src="http://s11.histats.com/js9.js"/></script> 
<noscript><img src="http://s103.histats.com/stats/0.gif?321314&1" alt="contatore free" border="0"/> 
</noscript> 

<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-4316218-1']);
  _gaq.push(['_setDomainName', 'andreafrancia.it']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


    </body>
</html>
